<!DOCTYPE html>
<script src="../js/lang.js"></script>
<style>
    *{
        outline: none;
        user-select: none;
        -webkit-user-select: none;
        scrollbar-width: thin;
        scrollbar-color: #0066ff #000;
        img{
            pointer-events: none;
        }
    }
    ::-webkit-scrollbar {
        width: 1.2rem;
        height: 1.2rem;
        background-color: #000;
        border-radius: 0.6rem;
    }

    ::-webkit-scrollbar-track {
        background: #000;
        border-radius: 0.6rem;
    }

    ::-webkit-scrollbar-thumb {
        background-color: #0066ff;
        border-radius: 1rem;
        border: 0.3rem solid #000;
        transition: background-color 0.3s ease;
    }

    ::-webkit-scrollbar-thumb:hover {
        background-color: #3399ff;
    }
  #NEWSMC,#NEWSST {
    max-width: 90%;
    margin: 1rem auto;
    font-family: Fredoka, Arial, Helvetica, sans-serif;
    color: white;
  }
  article {
    background-color: #1115;
    border-radius: 1rem;
    padding: 1rem;
    margin-bottom: 2rem;
    box-shadow: 0 0 8px rgba(0,0,0,0.8);
  }
  article h2 {
    margin: 0 0 0.3rem 0;
    font-weight: 700;
    font-size: 1.5rem;
  }
  article .date {
    font-size: 0.8rem;
    color: #aaa;
    margin-bottom: 0.6rem;
  }
  article img {
    aspect-ratio: 1/1;
    object-fit: cover;
    border-radius: 0.8rem;
    margin-bottom: 0.6rem;
    display: block;
    margin: auto;
  }
  article p.short-text {
    font-size: 1rem;
    line-height: 1.3;
  }
  #btnLoadMoreNews {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    pointer-events: all;
    margin: 1rem auto;
    padding: 0.7rem 1.5rem;
    font-size: 1rem;
    background-color: #333;
    color: white;
    border-radius: 0.6rem;
    border: none;
    cursor: pointer;
    z-index: 500;
    opacity: 0.5;
    transition: background-color 0.3s ease;
  }
  #btnLoadMoreNews:hover {
    opacity: 1;
    background-color: #555;
  }
</style>
<style>
    .Container{
        -webkit-user-select: text;
        user-select: all;
        width: 100%;
        height: 100%;
        position: relative;
    }
    .Other-Left, .Other-Right::before{
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle,transparent 80%,#0005);
      background-attachment: fixed;
      z-index: 1;
    }
    .Other-Left,.Other-Right{
      position: fixed;
      top: 0;
      width: 0%;
      height: 100dvh;
      padding: 0.5rem;
      z-index: 600;
    }
    .Other-Left{
      width: 50%;
      left: 0;
      background-color: #272727;
    }
    .Other-Right{
      width: 50%;
      right: 0;
      background-color: #272727;
    }
    .Other-Left.Active, .Other-Right.Active{
      width: 0%;
      animation: FadeIN 1s ease-in-out forwards;
    }
    .Other-Left.Disabled, .Other-Right.Disabled{
      width: 0%;
      animation: FadeOUT 1s ease-in-out forwards;
    }
    @keyframes FadeIN{
      100%{
        width: 50%;
      }
    }
    @keyframes FadeOUT{
      0%{
        width: 50%;
      }
      100%{
        pointer-events: none;
        opacity: 0;
        width: 0%;
      }
    }
</style>
<style>
  .loader {
    width: 1.5em;
    height: 1.5em;
    border: 0.3rem solid #FFF;
    border-bottom-color: transparent;
    border-radius: 50%;
    display: inline-block;
    box-sizing: border-box;
    animation: rotation 1s linear infinite;
  }
  @keyframes rotation {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
      }
  }
  .loaderContainer{
    position: fixed;
    bottom: 1rem;
    left: 1rem;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: Fredoka, Arial, Helvetica, sans-serif;
    gap: 0.5rem;
    z-index: 601;
    color: transparent;
    background: linear-gradient(90deg,#373737,#bbb 90%,#373737);
    background-size: 200% 200%;
    background-clip: text;
    animation: moveGradient 1s ease-in-out infinite;
    transition: opacity 100ms ease-in-out;
  }
  .loaderContainer.Disabled{
    opacity: 0;
  }
  @keyframes moveGradient {
  0% {
    background-position: 0% 0%;
  }
  100% {
    background-position: 200% 0%;
  }}
</style>
<div class="Container">
  <div class="loaderContainer Disabled">
    <div class="loader"></div>
    <h3 data-lang="Entries.Loaders.LoadNews"></h3>
  </div>
  <div class="Other-Left Disabled"></div>
  <select name="" id="SelectNews">
    <option value="Minecraft">Minecraft</option>
    <option value="StepLauncher">StepLauncher</option>
  </select>
  <div id="NEWSMC"></div>
  <div id="NEWSST" class="Disabled"></div>
  <div class="Other-Right Disabled"></div>
</div>
<style>
  select {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    width: 15rem;
    height: 2.5rem;
    padding: 0 1rem;
    background: linear-gradient(135deg, #2e2e2e, #3a3a3a);
    color: #f1f1f1;
    border: none;
    border-radius: 0.75rem;
    box-shadow: 0 0 0.3rem rgba(0, 0, 0, 0.5);
    font-family: "Comfortaa", Arial, sans-serif;
    font-size: 1.1rem;
    transition: background 0.3s ease, box-shadow 0.3s ease;
    outline: none;
    cursor: pointer;
  }

  select:hover {
    background: linear-gradient(135deg, #3a3a3a, #4a4a4a);
  }

  select:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 191, 255, 0.6);
  }
  option {
    background-color: #2e2e2e;
    color: #ffffff;
    font-family: "Comfortaa", sans-serif;
    font-size: 1rem;
  }
  .news-entry {
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 0.5rem;
    font-family: 'Comfortaa', Tahoma, Geneva, Verdana, sans-serif;
    background-color: rgba(30, 30, 30, 0.6);
    box-shadow: 0 0.2rem 0.5rem rgba(0, 0, 0, 0.2);
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    backdrop-filter: blur(5px);
    border-left: 0.4rem solid transparent;
    cursor: pointer;
  }

  .news-entry:hover {
    background-color: rgba(50, 50, 50, 0.7);
    transform: scale(1.01);
    box-shadow: 0 0.3rem 0.8rem rgba(0, 0, 0, 0.3);
  }

  .news-entry:focus-within,
  .news-entry:active {
    background-color: rgba(60, 60, 60, 0.8);
    outline: 2px solid #888;
  }

  /* Títulos y contenido */
  .news-entry .title {
    font-weight: 700;
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
    color: #f1f1f1;
  }

  .news-entry .date {
    font-weight: bold;
    text-decoration: underline;
    margin-bottom: 0.5rem;
    color: #b0bec5;
  }

  .news-entry .description {
    font-size: 1rem;
    line-height: 1.4;
    color: #e0e0e0;
  }
  .news-entry .links {
    margin-top: 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .news-entry .links a {
    background-color: rgba(255,255,255,0.05);
    padding: 0.4rem 0.8rem;
    border-radius: 0.4rem;
    color: #90caf9;
    text-decoration: none;
    font-size: 0.9rem;
    transition: background-color 0.3s;
  }

  .news-entry .links a:hover {
    background-color: rgba(255,255,255,0.1);
  }

  .news-entry img.news-image {
    max-width: 100%;
    margin-top: 0.8rem;
    border-radius: 0.4rem;
    box-shadow: 0 0 0.5rem rgba(0,0,0,0.2);
  }

  /* Tipos de noticias */
  .news-entry.important {
    border-left-color: #e53935;
  }

  .news-entry.update {
    border-left-color: #1e88e5;
  }

  .news-entry.event {
    border-left-color: #8e24aa;
  }

  .news-entry.info {
    border-left-color: #9e9e9e;
  }

  .news-entry.warning {
    border-left-color: #fbc02d;
  }

  .news-entry.community {
    border-left-color: #43a047;
  }

  .news-entry.other {
    border-left-color: #757575;
  }
</style>
<script>
// ========== CONFIGURACIÓN DE NOTICIAS ==========
const NEWS_CONTAINER_ID_MC = "NEWSMC";
const NEWS_CONTAINER_ID_ST = "NEWSST";
const NEWS_BATCH_SIZE = 15;

const LOADER_CLASSNAMES = [
  ".loaderContainer",
  ".Other-Left",
  ".Other-Right"
];

const NEWS_URLS = {
  Minecraft: "https://launchercontent.mojang.com/v2/javaPatchNotes.json",
  StepLauncher: "https://novastep-studios.web.app/launcher/news/news.json"
};

let allNews = [];
let loadedCount = 0;
let currentNewsType = "Minecraft";

function setLoaderActive(active) {
  LOADER_CLASSNAMES.forEach(selector => {
    const el = document.querySelector(selector);
    if (el) {
      el.classList.toggle("Disabled", !active);
      el.classList.toggle("Active", active);
    }
  });
}

function formatDateString(dateString) {
  if (!dateString) return "";
  const [year, month, day] = dateString.split("-");
  return `${day}/${month}/${year}`;
}

function formatFullDate(date) {
  const d = date.getDate().toString().padStart(2, "0");
  const m = (date.getMonth() + 1).toString().padStart(2, "0");
  const y = date.getFullYear();
  return `${d}/${m}/${y}`;
}

async function fetchNews(type) {
  try {
    const res = await fetch(NEWS_URLS[type]);
    if (!res.ok) throw new Error("Error al cargar noticias");
    const data = await res.json();

    allNews = type === "StepLauncher"
      ? (data.Entries || [])
      : (data.entries || data.news || []);

    loadedCount = 0;

    document.getElementById(NEWS_CONTAINER_ID_MC).innerHTML = "";
    document.getElementById(NEWS_CONTAINER_ID_ST).innerHTML = "";

    renderNewsBatch();
  } catch (err) {
    console.error(err);
  }
}

function renderNewsBatch() {
  const isStepLauncher = currentNewsType === "StepLauncher";
  const containerId = isStepLauncher ? NEWS_CONTAINER_ID_ST : NEWS_CONTAINER_ID_MC;
  const container = document.getElementById(containerId);
  if (!container) return;

  const nextCount = Math.min(loadedCount + NEWS_BATCH_SIZE, allNews.length);

  let html = "";
  for (let i = loadedCount; i < nextCount; i++) {
    const news = allNews[i];

    if (isStepLauncher) {
      const title = news.Title || null;
      const date = news.Date ? formatDateString(news.Date) : null;
      const description = news.Description || null;
      const image = news.Image || null;
      const links = news.Links || null;
      let type = (news.Type || "").toLowerCase();

      const validTypes = ["important", "update", "event", "info", "warning", "community", "other"];
      const hasValidType = validTypes.includes(type);

      html += `<article class="news-entry${hasValidType ? ` ${type}` : ""}">`;

      if (title) html += `<h2 class="title">${title}</h2>`;
      if (date) html += `<div class="date">${date}</div>`;
      if (image) html += `<img src="${image}" alt="Imagen">`;
      if (description) html += `<p class="description">${description}</p>`;

      if (links && typeof links === "object") {
        let linksHTML = "";
        if (links.Github) linksHTML += `<a href="#" data-link="${links.Github}" class="news-link">GitHub</a> `;
        if (links.Youtube) linksHTML += `<a href="#" data-link="${links.Youtube}" class="news-link">YouTube</a> `;
        if (links.Instagram) linksHTML += `<a href="#" data-link="${links.Instagram}" class="news-link">Instagram</a> `;
        if (links.NPM) linksHTML += `<a href="#" data-link="${links.NPM}" class="news-link">NPM</a> `;

        if (Array.isArray(links.Other)) {
          links.Other.forEach(link => {
            if (link && typeof link === "string" && link.trim() !== "") {
              linksHTML += `<a href="#" data-link="${link}" class="news-link">Otro</a> `;
            }
          });
        }
        if (linksHTML) html += `<div class="links">${linksHTML.trim()}</div>`;
      }
      html += `</article>`;
    } else {
      const dateObj = new Date(news.date || news.created_at || Date.now());
      const formattedDate = formatFullDate(dateObj);
      const imgUrl = news.image?.url
        ? "https://launchercontent.mojang.com" + news.image.url
        : (news.image || "");
      const imgAlt = news.image?.title || news.title || "Imagen";

      html += `<article>`;
      if (news.title) html += `<h2>${news.title}</h2>`;
      html += `<div class="date">${formattedDate}</div>`;
      if (imgUrl) html += `<img src="${imgUrl}" alt="${imgAlt}">`;
      if (news.shortText || news.content) html += `<p class="short-text">${news.shortText || news.content}</p>`;
      html += `</article>`;
    }
  }

  container.insertAdjacentHTML("beforeend", html);
  loadedCount = nextCount;

  let btn = document.getElementById("btnLoadMoreNews");
  if (!btn) {
    btn = document.createElement("button");
    btn.id = "btnLoadMoreNews";
    btn.textContent = "Cargar más noticias";
    btn.addEventListener("click", renderNewsBatch);
    container.after(btn);
  }

  btn.style.display = loadedCount >= allNews.length ? "none" : "inline-block";
}

// --- Aquí está el listener global para abrir links con electronApi ---
document.addEventListener("click", function (e) {
  const target = e.target;
  if (target.matches("a.news-link")) {
    e.preventDefault();
    const link = target.getAttribute("data-link");
    if (link) {
      if (window.electronApi && typeof window.electronApi.openLink === "function") {
        window.electronApi.openLink(link);
      } else {
        console.error("No se pudo abrir el link: no existe window.electronApi.openLink");
      }
    }
  }
});

document.getElementById("SelectNews").addEventListener("change", async (e) => {
  const selected = e.target.value;
  currentNewsType = selected;

  document.getElementById(NEWS_CONTAINER_ID_MC).classList.toggle("Disabled", selected !== "Minecraft");
  document.getElementById(NEWS_CONTAINER_ID_ST).classList.toggle("Disabled", selected !== "StepLauncher");

  setLoaderActive(true);

  setTimeout(() => {
    fetchNews(selected).then(() => {
      setLoaderActive(false);
    });
  }, 1000);
});

window.addEventListener("DOMContentLoaded", () => {
  setLoaderActive(true);

  setTimeout(() => {
    fetchNews(currentNewsType).then(() => {
      setLoaderActive(false);
    });
  }, 2000);
});

</script>
